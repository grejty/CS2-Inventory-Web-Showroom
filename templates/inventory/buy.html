{% extends 'base.html' %}
{% load inventory_tags %}

{% block title %}Grejty - CS2 SHOP | Skins{% endblock %}
{% block header %}Skins for sale:{% endblock %}

{% block content %}
    {% if error %}
        <div class="error-message"><strong>Error updating inventory:</strong><br>{{ error|cut:"Forbidden:"|striptags }}</div>
    {% else %}
        <!-- Search bar in the middle -->
        <div class="search-filter-container">
            <div class="search-input-wrapper">
                <input type="text" id="search-box" placeholder="Search items..." />
                <button id="filter-panel-toggle" class="filter-button" type="button" aria-label="Toggle filters">
                    &#128269;
                </button>
            </div>
        </div>

        <!-- MOVE FILTER PANEL HERE - DIRECTLY AFTER SEARCH BAR -->
        <div id="filter-panel">
            <div id="filters">
                <!-- Weapon Types -->
                <div class="filter-group" data-type="weapon_types">
                    <h3>Weapon Types</h3>
                    <div class="filter-options-grid">
                        {% for name, count in filters.weapon_types %}
                            <div class="filter-option">
                                <input type="checkbox" id="weapon_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="weapon_type">
                                <label for="weapon_{{ name }}">{{ name }}</label>
                                <span class="filter-count">{{ count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Item Types -->
                <div class="filter-group" data-type="item_types">
                    <h3>Item Types</h3>
                    <div class="filter-options-grid">
                        {% for name, count in filters.item_types %}
                            <div class="filter-option">
                                <input type="checkbox" id="type_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="item_type">
                                <label for="type_{{ name }}">{{ name }}</label>
                                <span class="filter-count">{{ count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Tradability -->
                <div class="filter-group" data-type="tradable">
                    <h3>Tradability</h3>
                    <div class="filter-options-grid">
                        {% for name, count in filters.tradable %}
                            <div class="filter-option">
                                <input type="checkbox" id="tradable_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="tradable">
                                <label for="tradable_{{ name }}">{{ name }}</label>
                                <span class="filter-count">{{ count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats container AFTER filter panel -->
        <div class="stats-controls-container justify-end">
            <div class="stats-row">
                <div class="inventory-stats">
                    Total:&nbsp;<strong>{{ total }}</strong>&nbsp;(showing&nbsp;<strong id="showing-count">{{ total }}</strong>)
                </div>
                <div class="sort-controls" role="group" aria-label="Sort by">
            <select id="sort-select" class="sort-select" aria-label="Sort by">
                <option value="tradable-desc">Newest</option>
                <option value="price-asc">Lowest Price</option>
                            <option value="price-desc">Highest Price</option>
                            <option value="float-asc">Lowest Float</option>
                            <option value="float-desc">Highest Float</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="inventory">
            {% for skin in skins %}
             <div class="skin-item" 
                 data-tradable="{{ skin.tradable_info.raw }}"
                 data-weapon="{{ skin.weapon_type }}"
                 data-type="{{ skin.item_type }}"
                 data-name="{{ skin.name|escape }}"
                 data-float="{% if skin.float is not None %}{{ skin.float|floatformat:6 }}{% endif %}"
                 data-price="{% if skin.price_eur %}{{ skin.price_eur }}{% endif %}"
                     {% if skin.rarity %}data-rarity="{{ skin.rarity }}"{% endif %}
                     {% if skin.rarity_color %}style="--rarity-color: {{ skin.rarity_color }};"{% endif %}>
                    <div class="skin-header">
                        <h3 class="skin-title">{{ skin.name|pipe_breaks }}</h3>
                        {% if 'Trade Protected' in skin.tradable_info.raw %}
                            <a href="https://help.steampowered.com/en/faqs/view/365F-4BEE-2AE2-7BDD" class="trade-protected-badge" target="_blank" rel="noopener noreferrer" data-tooltip="Trade protected items cannot be modified, consumed, or transferred" aria-label="Trade protected items cannot be modified, consumed, or transferred">
                                <span class="badge-icon" aria-hidden="true">
                                    <svg viewBox="0 0 24 28" focusable="false" aria-hidden="true">
                                            <path d="M12 1.5l8 2.9v6.6c0 5.2-3.5 10.1-8 12-4.5-1.9-8-6.8-8-12V4.4z" fill="#facc15"/>
                                            <path d="M12 3.2l6 2.2v5.5c0 4.2-2.8 8.2-6 9.5-3.2-1.3-6-5.3-6-9.5V5.4z" fill="#fde047"/>
                                            <path d="M12 1.5l8 2.9v6.6c0 5.2-3.5 10.1-8 12-4.5-1.9-8-6.8-8-12V4.4z" fill="none" stroke="#f59e0b" stroke-width="1.1" stroke-linejoin="round"/>
                                            <g transform="translate(0 2) rotate(90 12 12) scale(0.6) translate(4 8.5)">
                                                <path d="M10 16H5V21M14 8H19V3M4.583 9.003C5.144 7.616 6.082 6.413 7.293 5.532C8.503 4.651 9.937 4.128 11.43 4.021C12.923 3.913 14.415 4.227 15.738 4.927C17.062 5.626 18.161 6.683 18.914 7.976M19.418 14.997C18.857 16.385 17.918 17.587 16.708 18.468C15.498 19.349 14.065 19.872 12.572 19.979C11.079 20.086 9.586 19.772 8.263 19.073C6.939 18.374 5.839 17.317 5.086 16.024" fill="none" stroke="#92400e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            </g>
                                        </svg>
                                </span>
                            </a>
                        {% endif %}
                        <p class="skin-exterior{% if not skin.exterior or skin.exterior == 'Not Painted' %} skin-exterior-placeholder{% endif %}">
                            {% if skin.exterior and skin.exterior != "Not Painted" %}
                                {{ skin.exterior }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="skin-image">
                        {% if skin.stickers or skin.patches %}
                            <div class="sticker-stack">
                                {% for sticker in skin.stickers %}
                                    <a class="sticker-thumb"
                                       href="https://steamcommunity.com/market/listings/730/{{ "Sticker | "|add:sticker.name|default:"Sticker"|urlencode }}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       data-tooltip="{{ sticker.name|default:"Sticker" }}"
                                       aria-label="{{ sticker.name|default:"Sticker" }}">
                                        <img src="{{ sticker.icon_url }}" alt="{{ sticker.name|default:"Sticker" }}">
                                    </a>
                                {% endfor %}
                                {% for patch in skin.patches %}
                                    <a class="sticker-thumb sticker-thumb--patch"
                                       href="https://steamcommunity.com/market/listings/730/{{ "Patch | "|add:patch.name|default:"Patch"|urlencode }}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       data-tooltip="{{ patch.name|default:"Patch" }}"
                                       aria-label="{{ patch.name|default:"Patch" }}">
                                        <img src="{{ patch.icon_url }}" alt="{{ patch.name|default:"Patch" }}">
                                    </a>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <img src="https://community.cloudflare.steamstatic.com/economy/image/{{ skin.icon_url }}" alt="{{ skin.name }}">
                    </div>
                    <div class="skin-details">
                        {% if skin.float is not None %}
                            <div class="float-bar-container" style="--float-value: {{ skin.float }};">
                                <div class="float-bar" role="presentation">
                                    <span class="float-segment segment-fn" data-tooltip="Factory New (0.00 – 0.07)" aria-hidden="true"></span>
                                    <span class="float-segment segment-mw" data-tooltip="Minimal Wear (0.07 – 0.15)" aria-hidden="true"></span>
                                    <span class="float-segment segment-ft" data-tooltip="Field-Tested (0.15 – 0.38)" aria-hidden="true"></span>
                                    <span class="float-segment segment-ww" data-tooltip="Well-Worn (0.38 – 0.45)" aria-hidden="true"></span>
                                    <span class="float-segment segment-bs" data-tooltip="Battle-Scarred (0.45 – 1.00)" aria-hidden="true"></span>
                                </div>
                                <span class="float-indicator" aria-hidden="true"></span>
                            </div>
                                <div class="float-stats" aria-label="Float and pattern information">
                                <span class="float-value" data-tooltip="Float value&#10;controls how much wear the skin has and ranges from 0-1">{{ skin.float|floatformat:6 }}</span>
                                <span class="paint-seed" data-tooltip="Paint seed&#10;controls the texture placement of the skin and ranges from 0-1000">
                                    {% if skin.pattern_template %}
                                        {{ skin.pattern_template }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </span>
                            </div>
                        {% elif skin.item_type == "Agent" and skin.collection %}
                            <div class="skin-collection" aria-label="Collection">{{ skin.collection }}</div>
                        {% endif %}
                    </div>
                    <div class="skin-footer">
                        <div class="skin-actions">
                            {% with info=skin.tradable_info %}
                                <div class="meta {% if info %}{{ info.state_class }}{% else %}meta--unlocked{% endif %}"
                                     data-lock-state="{% if info and info.lock_state %}{{ info.lock_state }}{% else %}unlocked{% endif %}"
                                     {% if info and info.unlock_iso %}data-unlock="{{ info.unlock_iso }}"{% endif %}
                                     aria-label="{% if info and info.unlock_text %}{{ info.unlock_text }}{% else %}Tradable{% endif %}">
                                    <span class="meta-icon" aria-hidden="true"></span>
                                    {% if info and not info.is_tradable and info.unlock_text %}
                                        <span class="meta-text">{{ info.unlock_text }}</span>
                                    {% endif %}
                                </div>
                            {% endwith %}
                            {% if skin.inspect_link %}
                                <a href="{{ skin.inspect_link }}" class="inspect-btn" data-inspect-link="{{ skin.inspect_link }}" aria-label="Inspect in Game" data-tooltip="Inspect in Game">
                                    <span class="inspect-icon" aria-hidden="true"></span>
                                </a>
                            {% endif %}
                        </div>
                        {% if skin.price_eur %}
                            <div class="skin-price skin-price--display" aria-label="Price">
                                <span class="skin-price__label">Price</span>
                                {% with price_str=skin.price_eur|stringformat:"s" %}
                                    {% if price_str|length > 3 and price_str|slice:"-3:" == '.00' %}
                                        <span class="skin-price__value"><span class="skin-price__currency">€</span>{{ price_str|slice:":-3" }}</span>
                                    {% else %}
                                        <span class="skin-price__value"><span class="skin-price__currency">€</span>{{ price_str }}</span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        {% else %}
                            <div class="skin-price skin-price--empty" aria-label="Price not set">
                                <span class="skin-price__label">Price</span>
                                <span class="skin-price__value">—</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {% if not error %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterPanel = document.getElementById('filter-panel');
            const filterButton = document.getElementById('filter-panel-toggle');
            
            // Initial filter panel state
            filterPanel.style.display = 'none';

            filterButton.addEventListener('click', function() {
                const isHidden = filterPanel.style.display === 'none' || !filterPanel.style.display;
                filterPanel.style.display = isHidden ? 'block' : 'none';
                filterButton.classList.toggle('panel-open', isHidden);
            });
            
            // Handle filters and search
            const searchBox = document.getElementById('search-box');
            const inventoryContainer = document.getElementById('inventory');
            const items = Array.from(inventoryContainer.querySelectorAll('.skin-item'));
            const defaultOrder = items.slice();
            const sortSelect = document.getElementById('sort-select');
            const showingCount = document.getElementById('showing-count');
            const checkboxes = document.querySelectorAll('.filter-checkbox');
            
            // Add clickable selection functionality to items
            items.forEach(item => {
                item.addEventListener('click', function(event) {
                    if (event.target.closest('.inspect-btn') || event.target.closest('.trade-protected-badge') || event.target.closest('.sticker-thumb')) {
                        return;
                    }

                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Toggle selected class for visual feedback
                    this.classList.toggle('selected');
                });
            });
            
            function applyFilters() {
                const searchTerm = searchBox.value.toLowerCase();
                const activeFilters = {
                    tradable: getActiveValues('tradable'),
                    weapon: getActiveValues('weapon_type'),  // Fixed: was 'weapon'
                    type: getActiveValues('item_type')       // Fixed: was 'type'
                };
                
                let visibleCount = 0;
                
                // Apply filters to each item
                let orderedItems;
                if (!sortSelect) {
                    orderedItems = defaultOrder;
                } else {
                    const mode = sortSelect.value;
                    if (mode === 'float-asc' || mode === 'float-desc') {
                        orderedItems = [...defaultOrder].sort((a, b) => {
                            const floatA = parseFloat(a.dataset.float);
                            const floatB = parseFloat(b.dataset.float);
                            const isAsc = mode === 'float-asc';

                            const aValid = Number.isFinite(floatA);
                            const bValid = Number.isFinite(floatB);
                            if (!aValid && !bValid) return 0;
                            if (!aValid) return 1;
                            if (!bValid) return -1;
                            return isAsc ? floatA - floatB : floatB - floatA;
                        });
                    } else if (mode === 'price-asc' || mode === 'price-desc') {
                        orderedItems = [...defaultOrder].sort((a, b) => {
                            const priceA = parseFloat(a.dataset.price);
                            const priceB = parseFloat(b.dataset.price);
                            const isAsc = mode === 'price-asc';

                            const aValid = Number.isFinite(priceA);
                            const bValid = Number.isFinite(priceB);
                            if (!aValid && !bValid) return 0;
                            if (!aValid) return 1;
                            if (!bValid) return -1;
                            return isAsc ? priceA - priceB : priceB - priceA;
                        });
                    } else {
                        orderedItems = defaultOrder;
                    }
                }

                orderedItems.forEach(item => {
                    const tradable = item.dataset.tradable;
                    const weapon = item.dataset.weapon;
                    const type = item.dataset.type;
                    const itemText = item.textContent.toLowerCase();
                    
                    const matchesTradable = activeFilters.tradable.length === 0 || activeFilters.tradable.includes(tradable);
                    const matchesWeapon = activeFilters.weapon.length === 0 || activeFilters.weapon.includes(weapon);
                    const matchesType = activeFilters.type.length === 0 || activeFilters.type.includes(type);
                    const matchesSearch = searchTerm === '' || itemText.includes(searchTerm);
                    
                    const isVisible = matchesTradable && matchesWeapon && matchesType && matchesSearch;
                    item.style.display = isVisible ? 'flex' : 'none';
                    inventoryContainer.appendChild(item);
                    
                    if (isVisible) {
                        visibleCount++;
                    }
                });
                
                // Update count
                showingCount.textContent = visibleCount;
            }
            
            // Helper to get active values for a filter category
            function getActiveValues(filterType) {
                const values = [];
                document.querySelectorAll(`.filter-checkbox[data-type="${filterType}"]:checked`).forEach(cb => {
                    values.push(cb.value);
                });
                return values;
            }
            
            // Apply filters when inputs change
            searchBox.addEventListener('input', applyFilters);
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });

            if (sortSelect) {
                sortSelect.addEventListener('change', applyFilters);
            }
            
            // Initialize filters on page load
            applyFilters();

            if (window.InventoryUI) {
                window.InventoryUI.bindSkinActions(document.getElementById('inventory'));
            }
        });
    </script>
    {% endif %}
{% endblock %}
