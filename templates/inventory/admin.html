{% extends 'base.html' %}

{% block title %}Grejty - CS2 SHOP | Admin{% endblock %}

{% block header %}Admin Panel{% endblock %}

{% block content %}
    {% if error %}
        <div class="error-message"><strong>Error updating inventory:</strong><br>{{ error|cut:"Forbidden:"|striptags }}</div>
        <div><a href="{{ access_token_url }}" target="_blank" class="button">Get Access Token</a></div>
    {% else %}
        <form method="post" id="admin-form">
            {% csrf_token %}
            
            <!-- Search bar in the middle -->
            <div class="search-filter-container">
                <div class="search-input-wrapper">
                    <input type="text" id="search-box" placeholder="Search items..." />
                    <button id="filter-panel-toggle" class="filter-button" type="button" aria-label="Toggle filters">
                        &#128269;
                    </button>
                </div>
            </div>

            <!-- MOVE FILTER PANEL HERE - DIRECTLY AFTER SEARCH BAR -->
            <div id="filter-panel">
                <div id="filters">
                    <!-- Weapon Types -->
                    <div class="filter-group" data-type="weapon_types">
                        <h3>Weapon Types</h3>
                        <div class="filter-options-grid">
                            {% for name, count in filters.weapon_types %}
                                <div class="filter-option">
                                    <input type="checkbox" id="weapon_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="weapon">
                                    <label for="weapon_{{ name }}">{{ name }}</label>
                                    <span class="filter-count">{{ count }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Item Types -->
                    <div class="filter-group" data-type="item_types">
                        <h3>Item Types</h3>
                        <div class="filter-options-grid">
                            {% for name, count in filters.item_types %}
                                <div class="filter-option">
                                    <input type="checkbox" id="type_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="type">
                                    <label for="type_{{ name }}">{{ name }}</label>
                                    <span class="filter-count">{{ count }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Tradability -->
                    <div class="filter-group" data-type="tradable">
                        <h3>Tradability</h3>
                        <div class="filter-options-grid">
                            {% for name, count in filters.tradable %}
                                <div class="filter-option">
                                    <input type="checkbox" id="tradable_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="tradable">
                                    <label for="tradable_{{ name }}">{{ name }}</label>
                                    <span class="filter-count">{{ count }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="manual-import" data-show="{{ show_manual_import|yesno:'true,false' }}" hidden>
                <div class="manual-import-header">
                    <h3>Manual Steam Inventory Import</h3>
                    <div class="manual-links">
                        <a href="{{ steam_inventory_urls.protected }}" target="_blank" rel="noopener noreferrer" class="button open-steam">Open Trade-Protected (context 16)</a>
                        <a href="{{ steam_inventory_urls.main }}" target="_blank" rel="noopener noreferrer" class="button open-steam">Open Main Inventory (context 2)</a>
                    </div>
                </div>
                <div class="manual-fields">
                    <div class="manual-field">
                        <label for="inventory-json-protected" class="manual-label">Trade-protected inventory JSON (context 16)</label>
                        <textarea id="inventory-json-protected" name="inventory_json_protected" rows="2" placeholder="Paste the JSON response from context 16 here">{{ pasted_json_protected }}</textarea>
                    </div>
                    <div class="manual-field">
                        <label for="inventory-json-main" class="manual-label">Primary inventory JSON (context 2)</label>
                        <textarea id="inventory-json-main" name="inventory_json_main" rows="2" placeholder="Paste the JSON response from context 2 here">{{ pasted_json_main }}</textarea>
                    </div>
                </div>
                <p id="manual-refresh-hint" class="manual-hint" hidden></p>
            </div>

            <!-- Stats and controls container AFTER filter panel -->
            <div class="stats-controls-container">
                <!-- Selection buttons on left -->
                <div class="selection-controls">
                    <button type="button" id="select-all-btn" class="selection-btn">Select All</button>
                    <button type="button" id="clear-selection-btn" class="selection-btn">Clear</button>
                    <button type="submit" class="selection-btn save-btn" name="action" value="save_selection" id="save-btn">Save Selection</button>
                </div>

                <!-- Stats and refresh on right -->
                <div class="stats-row">
                    <div class="inventory-stats">
                        Total:&nbsp;<strong>{{ total_before_filters }}</strong>&nbsp;(showing&nbsp;<strong id="showing-count">{{ total }}</strong>)
                    </div>
                    <button type="submit" class="refresh-btn tooltip" name="action" value="refresh_inventory" data-tooltip="Refresh Inventory from Steam API"></button>
                </div>
            </div>

            <div id="inventory">
                {% for skin in skins %}
                    <div class="skin-item admin-selectable{% if skin.selected %} selected{% endif %}" 
                         data-tradable="{{ skin.tradable }}"
                         data-weapon="{{ skin.weapon_type }}"
                         data-type="{{ skin.item_type }}"
                         data-index="{{ forloop.counter0 }}"
                         data-name="{{ skin.name|escape }}"
                         {% if skin.rarity %}data-rarity="{{ skin.rarity }}"{% endif %}
                         {% if skin.rarity_color %}style="--rarity-color: {{ skin.rarity_color }};"{% endif %}>
                        <div class="skin-header{% if skin.stickers %} has-stickers{% endif %}">
                            <h3 class="skin-title">{{ skin.name }}</h3>
                            {% if skin.exterior and skin.exterior != "Not Painted" %}
                                <p class="skin-exterior">{{ skin.exterior }}</p>
                            {% endif %}
                            {% if skin.stickers %}
                                <div class="sticker-stack">
                                    {% for sticker in skin.stickers %}
                                        <div class="sticker-thumb" data-tooltip="{{ sticker.name }}" aria-label="{{ sticker.name }}">
                                            <img src="{{ sticker.icon_url }}" alt="{{ sticker.name }}">
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="skin-image">
                            {% if 'Trade Protected' in skin.tradable %}
                                <a href="https://help.steampowered.com/en/faqs/view/365F-4BEE-2AE2-7BDD" class="trade-protected-badge" target="_blank" rel="noopener noreferrer" data-tooltip="Trade protected items cannot be modified, consumed, or transferred" aria-label="Trade protected items cannot be modified, consumed, or transferred">
                                    <span class="badge-icon" aria-hidden="true">
                                        <svg viewBox="0 0 24 28" focusable="false" aria-hidden="true">
                                            <path d="M12 1.5l8 2.9v6.6c0 5.2-3.5 10.1-8 12-4.5-1.9-8-6.8-8-12V4.4z" fill="#facc15"/>
                                            <path d="M12 3.2l6 2.2v5.5c0 4.2-2.8 8.2-6 9.5-3.2-1.3-6-5.3-6-9.5V5.4z" fill="#fde047"/>
                                            <path d="M12 1.5l8 2.9v6.6c0 5.2-3.5 10.1-8 12-4.5-1.9-8-6.8-8-12V4.4z" fill="none" stroke="#f59e0b" stroke-width="1.1" stroke-linejoin="round"/>
                                            <g transform="translate(0 2) rotate(90 12 12) scale(0.6) translate(4 8.5)">
                                                <path d="M10 16H5V21M14 8H19V3M4.583 9.003C5.144 7.616 6.082 6.413 7.293 5.532C8.503 4.651 9.937 4.128 11.43 4.021C12.923 3.913 14.415 4.227 15.738 4.927C17.062 5.626 18.161 6.683 18.914 7.976M19.418 14.997C18.857 16.385 17.918 17.587 16.708 18.468C15.498 19.349 14.065 19.872 12.572 19.979C11.079 20.086 9.586 19.772 8.263 19.073C6.939 18.374 5.839 17.317 5.086 16.024" fill="none" stroke="#92400e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            </g>
                                        </svg>
                                    </span>
                                </a>
                            {% endif %}
                            <img src="https://community.cloudflare.steamstatic.com/economy/image/{{ skin.icon_url }}" alt="{{ skin.name }}">
                            <input type="checkbox" name="selected_skins" value="{{ forloop.counter0 }}" {% if skin.selected %}checked{% endif %} class="skin-checkbox" style="display: none;">
                        </div>
                        <div class="skin-details">
                            {% if skin.float is not None %}
                                <div class="float-bar-container" style="--float-value: {{ skin.float }};">
                                    <div class="float-bar" role="presentation">
                                        <span class="float-segment segment-fn" data-tooltip="Factory New (0.00 – 0.07)" aria-hidden="true"></span>
                                        <span class="float-segment segment-mw" data-tooltip="Minimal Wear (0.07 – 0.15)" aria-hidden="true"></span>
                                        <span class="float-segment segment-ft" data-tooltip="Field-Tested (0.15 – 0.38)" aria-hidden="true"></span>
                                        <span class="float-segment segment-ww" data-tooltip="Well-Worn (0.38 – 0.45)" aria-hidden="true"></span>
                                        <span class="float-segment segment-bs" data-tooltip="Battle-Scarred (0.45 – 1.00)" aria-hidden="true"></span>
                                    </div>
                                    <span class="float-indicator" aria-hidden="true"></span>
                                </div>
                                <div class="float-stats" aria-label="Float and pattern information">
                                    <span class="float-value" data-tooltip="Float value&#10;controls how much wear the skin has and ranges from 0-1">{{ skin.float|floatformat:6 }}</span>
                                    <span class="paint-seed" data-tooltip="Paint seed&#10;controls the texture placement of the skin and ranges from 0-1000">
                                        {% if skin.pattern_template %}
                                            {{ skin.pattern_template }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                            <div class="meta"><span class="label">Tradable:</span> {{ skin.tradable }}</div>
                        </div>
                        <div class="skin-actions">
                                {% if skin.inspect_link %}
                                <a href="{{ skin.inspect_link }}" class="inspect-btn" data-inspect-link="{{ skin.inspect_link }}" aria-label="Inspect in Game" data-tooltip="Inspect in Game">
                                    <span class="inspect-icon" aria-hidden="true"></span>
                                </a>
                                {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </form>
    {% endif %}
{% endblock %}

{% block scripts %}
    {% if not error %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const filterToggle = document.getElementById('filter-panel-toggle');
            const filterPanel = document.getElementById('filter-panel');
            const searchBox = document.getElementById('search-box');
            const items = document.querySelectorAll('.skin-item');
            const showingCount = document.getElementById('showing-count');
            const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
            const selectAllBtn = document.getElementById('select-all-btn');
            const clearSelectionBtn = document.getElementById('clear-selection-btn');
            const adminForm = document.getElementById('admin-form');
            const refreshBtn = document.querySelector('.refresh-btn');
            const manualImportSection = document.querySelector('.manual-import');
            const inventoryJsonProtected = document.getElementById('inventory-json-protected');
            const inventoryJsonMain = document.getElementById('inventory-json-main');
            const refreshHint = document.getElementById('manual-refresh-hint');

            // Initial manual import state
            let manualImportRevealed = false;
            if (manualImportSection) {
                const shouldStartVisible = manualImportSection.dataset.show === 'true';
                manualImportRevealed = shouldStartVisible;

                if (shouldStartVisible) {
                    manualImportSection.removeAttribute('hidden');
                    manualImportSection.style.display = '';
                } else {
                    manualImportSection.setAttribute('hidden', '');
                    manualImportSection.style.display = 'none';
                }

                if (refreshHint) {
                    refreshHint.textContent = '';
                    refreshHint.setAttribute('hidden', '');
                }
            }

            // Initial filter panel state
            filterPanel.style.display = 'none';

            if (window.formatSkinTitles) {
                window.formatSkinTitles();
            }

            // Toggle filter panel with consistent behavior
            filterToggle.addEventListener('click', function() {
                const isHidden = filterPanel.style.display === 'none' || !filterPanel.style.display;
                filterPanel.style.display = isHidden ? 'block' : 'none';
                filterToggle.classList.toggle('panel-open', isHidden);
            });

            if (refreshBtn && manualImportSection) {
                refreshBtn.addEventListener('click', function(event) {
                    const hasProtected = inventoryJsonProtected && inventoryJsonProtected.value.trim();
                    const hasMain = inventoryJsonMain && inventoryJsonMain.value.trim();

                    if (!manualImportRevealed) {
                        manualImportSection.removeAttribute('hidden');
                        manualImportSection.style.display = '';
                        manualImportRevealed = true;
                        if (refreshHint) {
                            refreshHint.textContent = '';
                            refreshHint.setAttribute('hidden', '');
                        }
                        event.preventDefault();
                        event.stopPropagation();
                        return;
                    }

                    if (!hasProtected || !hasMain) {
                        if (refreshHint) {
                            refreshHint.textContent = 'Both JSON fields are required before refreshing.';
                            refreshHint.removeAttribute('hidden');
                        }
                        event.preventDefault();
                        event.stopPropagation();
                        return;
                    }

                    manualImportSection.setAttribute('hidden', '');
                    manualImportSection.style.display = 'none';
                    manualImportRevealed = false;
                    if (refreshHint) {
                        refreshHint.textContent = '';
                        refreshHint.setAttribute('hidden', '');
                    }
                });
            }

            // Make items clickable for selection
            items.forEach(item => {
                const checkbox = item.querySelector('.skin-checkbox');

                item.addEventListener('click', function(event) {
                    if (event.target.closest('.inspect-btn') || event.target.closest('.trade-protected-badge')) {
                        return;
                    }

                    event.preventDefault();
                    event.stopPropagation();

                    this.classList.toggle('selected');

                    if (checkbox) {
                        checkbox.checked = this.classList.contains('selected');
                    }
                });
            });
            
            // Select All functionality - only visible items
            selectAllBtn.addEventListener('click', function(event) {
                event.preventDefault();
                
                items.forEach(item => {
                    if (item.style.display !== 'none') {
                        item.classList.add('selected');
                        const checkbox = item.querySelector('.skin-checkbox');
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    }
                });
            });
            
            // Clear Selection functionality
            clearSelectionBtn.addEventListener('click', function(event) {
                event.preventDefault();
                
                items.forEach(item => {
                    item.classList.remove('selected');
                    const checkbox = item.querySelector('.skin-checkbox');
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                });
            });
            
            // Filter application function
            function applyFilters() {
                const searchTerm = searchBox.value.toLowerCase();
                const activeFilters = {
                    tradable: getActiveValues('tradable'),
                    weapon: getActiveValues('weapon'),
                    type: getActiveValues('type')
                };
                
                let visibleCount = 0;
                
                // Apply filters to each item
                items.forEach(item => {
                    const tradable = item.dataset.tradable;
                    const weapon = item.dataset.weapon;
                    const type = item.dataset.type;
                    const itemText = item.textContent.toLowerCase();
                    
                    const matchesTradable = activeFilters.tradable.length === 0 || activeFilters.tradable.includes(tradable);
                    const matchesWeapon = activeFilters.weapon.length === 0 || activeFilters.weapon.includes(weapon);
                    const matchesType = activeFilters.type.length === 0 || activeFilters.type.includes(type);
                    const matchesSearch = searchTerm === '' || itemText.includes(searchTerm);
                    
                    const isVisible = matchesTradable && matchesWeapon && matchesType && matchesSearch;
                    item.style.display = isVisible ? 'flex' : 'none';
                    
                    if (isVisible) {
                        visibleCount++;
                    }
                });
                
                // Update count
                showingCount.textContent = visibleCount;
            }
            
            // Helper to get active values for a filter category
            function getActiveValues(filterType) {
                const values = [];
                document.querySelectorAll(`.filter-checkbox[data-type="${filterType}"]:checked`).forEach(cb => {
                    values.push(cb.value);
                });
                return values;
            }
            
            // Apply filters when inputs change
            searchBox.addEventListener('input', applyFilters);
            filterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
            
            // Form submit handler for empty selection
            if (adminForm) {
                adminForm.addEventListener('submit', function(event) {
                    const selectedCheckboxes = document.querySelectorAll('.skin-checkbox:checked');
                    
                    if (selectedCheckboxes.length === 0) {
                        // Add a hidden field to indicate we want to clear all selections
                        const clearFlag = document.createElement('input');
                        clearFlag.type = 'hidden';
                        clearFlag.name = 'clear_all';
                        clearFlag.value = 'true';
                        this.appendChild(clearFlag);
                    }
                });
            }

            // Initialize filters on page load
            applyFilters();

            if (window.InventoryUI) {
                window.InventoryUI.bindSkinActions(document.getElementById('inventory'));
            }
        });
    </script>
    {% endif %}
{% endblock %}

