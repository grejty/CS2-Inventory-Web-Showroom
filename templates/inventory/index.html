{% extends 'base.html' %}

{% block title %}Grejty - CS2 SHOP | Skins{% endblock %}

{% block header %}Skins for sale:{% endblock %}

{% block content %}
    {% if error %}
        <div class="error-message"><strong>Error updating inventory:</strong><br>{{ error|cut:"Forbidden:"|striptags }}</div>
        <div><a href="{{ access_token_url }}" target="_blank" class="button">Get Access Token</a></div>
    {% else %}
        <!-- Search bar in the middle -->
        <div class="search-filter-container">
            <div class="search-input-wrapper">
                <input type="text" id="search-box" placeholder="Search items..." />
                <button id="filter-panel-toggle" class="filter-button" type="button" aria-label="Toggle filters">
                    &#128269;
                </button>
            </div>
        </div>

        <!-- MOVE FILTER PANEL HERE - DIRECTLY AFTER SEARCH BAR -->
        <div id="filter-panel">
            <div id="filters">
                <!-- Weapon Types -->
                <div class="filter-group" data-type="weapon_types">
                    <h3>Weapon Types</h3>
                    <div class="filter-options-grid">
                        {% for name, count in filters.weapon_types %}
                            <div class="filter-option">
                                <input type="checkbox" id="weapon_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="weapon_type">
                                <label for="weapon_{{ name }}">{{ name }}</label>
                                <span class="filter-count">{{ count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Item Types -->
                <div class="filter-group" data-type="item_types">
                    <h3>Item Types</h3>
                    <div class="filter-options-grid">
                        {% for name, count in filters.item_types %}
                            <div class="filter-option">
                                <input type="checkbox" id="type_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="item_type">
                                <label for="type_{{ name }}">{{ name }}</label>
                                <span class="filter-count">{{ count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Tradability -->
                <div class="filter-group" data-type="tradable">
                    <h3>Tradability</h3>
                    <div class="filter-options-grid">
                        {% for name, count in filters.tradable %}
                            <div class="filter-option">
                                <input type="checkbox" id="tradable_{{ name }}" value="{{ name }}" class="filter-checkbox" data-type="tradable">
                                <label for="tradable_{{ name }}">{{ name }}</label>
                                <span class="filter-count">{{ count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats container AFTER filter panel -->
        <div class="stats-controls-container justify-end">
            <div class="stats-row">
                <div class="inventory-stats">
                    Total:&nbsp;<strong>{{ total }}</strong>&nbsp;(showing&nbsp;<strong id="showing-count">{{ total }}</strong>)
                </div>
            </div>
        </div>

        <div id="inventory">
            {% for skin in skins %}
                <div class="skin-item" 
                     data-tradable="{{ skin.tradable }}"
                     data-weapon="{{ skin.weapon_type }}"
                     data-type="{{ skin.item_type }}"
                     data-name="{{ skin.name|escape }}"
                     {% if skin.rarity %}data-rarity="{{ skin.rarity }}"{% endif %}
                     {% if skin.rarity_color %}style="--rarity-color: {{ skin.rarity_color }};"{% endif %}>
                    <div class="skin-header{% if skin.stickers %} has-stickers{% endif %}">
                        <h3 class="skin-title">{{ skin.name }}</h3>
                        {% if skin.exterior and skin.exterior != "Not Painted" %}
                            <p class="skin-exterior">{{ skin.exterior }}</p>
                        {% endif %}
                        {% if skin.stickers %}
                            <div class="sticker-stack">
                                {% for sticker in skin.stickers %}
                                    <div class="sticker-thumb" title="{{ sticker.name }}">
                                        <img src="{{ sticker.icon_url }}" alt="{{ sticker.name }}">
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="skin-image">
                        {% if 'Trade Protected' in skin.tradable %}
                            <a href="https://help.steampowered.com/en/faqs/view/365F-4BEE-2AE2-7BDD" class="trade-protected-badge" target="_blank" rel="noopener noreferrer" title="Trade protected items cannot be modified, consumed, or transferred.">
                                <span class="badge-icon" aria-hidden="true">
                                    <svg viewBox="0 0 24 28" focusable="false" aria-hidden="true">
                                            <path d="M12 1.5l8 2.9v6.6c0 5.2-3.5 10.1-8 12-4.5-1.9-8-6.8-8-12V4.4z" fill="#facc15"/>
                                            <path d="M12 3.2l6 2.2v5.5c0 4.2-2.8 8.2-6 9.5-3.2-1.3-6-5.3-6-9.5V5.4z" fill="#fde047"/>
                                            <path d="M12 1.5l8 2.9v6.6c0 5.2-3.5 10.1-8 12-4.5-1.9-8-6.8-8-12V4.4z" fill="none" stroke="#f59e0b" stroke-width="1.1" stroke-linejoin="round"/>
                                            <g transform="translate(0 2) rotate(90 12 12) scale(0.6) translate(4 8.5)"">
                                                <path d="M10 16H5V21M14 8H19V3M4.583 9.003C5.144 7.616 6.082 6.413 7.293 5.532C8.503 4.651 9.937 4.128 11.43 4.021C12.923 3.913 14.415 4.227 15.738 4.927C17.062 5.626 18.161 6.683 18.914 7.976M19.418 14.997C18.857 16.385 17.918 17.587 16.708 18.468C15.498 19.349 14.065 19.872 12.572 19.979C11.079 20.086 9.586 19.772 8.263 19.073C6.939 18.374 5.839 17.317 5.086 16.024" fill="none" stroke="#92400e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            </g>
                                        </svg>
                                </span>
                            </a>
                        {% endif %}
                        <img src="https://community.cloudflare.steamstatic.com/economy/image/{{ skin.icon_url }}" alt="{{ skin.name }}">
                    </div>
                    <div class="skin-details">
                        {% if skin.float is not None %}
                            <div class="float-bar-container" style="--float-value: {{ skin.float }};">
                                <div class="float-bar" role="presentation">
                                    <span class="float-segment segment-fn" title="Factory New (0.00 – 0.07)" aria-hidden="true"></span>
                                    <span class="float-segment segment-mw" title="Minimal Wear (0.07 – 0.15)" aria-hidden="true"></span>
                                    <span class="float-segment segment-ft" title="Field-Tested (0.15 – 0.38)" aria-hidden="true"></span>
                                    <span class="float-segment segment-ww" title="Well-Worn (0.38 – 0.45)" aria-hidden="true"></span>
                                    <span class="float-segment segment-bs" title="Battle-Scarred (0.45 – 1.00)" aria-hidden="true"></span>
                                </div>
                                <span class="float-indicator" aria-hidden="true"></span>
                            </div>
                                <div class="float-stats" aria-label="Float and pattern information">
                                <span class="float-value" title="Float Value&#10;Controls how much wear the skin has and ranges from 0-1">{{ skin.float|floatformat:6 }}</span>
                                <span class="paint-seed" title="Paint Seed&#10;Controls the texture placement of the skin and ranges from 0-1000">
                                    {% if skin.pattern_template %}
                                        {{ skin.pattern_template }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </span>
                            </div>
                        {% endif %}
                        <div class="meta" data-tradable="{{ skin.tradable }}">
                            <span class="label">Tradable:</span>
                            <span class="value">{{ skin.tradable }}</span>
                        </div>
                    </div>
                    <div class="skin-actions">
                        {% if skin.inspect_link %}
                            <a href="{{ skin.inspect_link }}" class="inspect-btn" data-inspect-link="{{ skin.inspect_link }}" aria-label="Inspect in Game" title="Inspect in Game">
                                <span class="inspect-icon" aria-hidden="true"></span>
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {% if not error %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterPanel = document.getElementById('filter-panel');
            const filterButton = document.getElementById('filter-panel-toggle');
            
            // Initial filter panel state
            filterPanel.style.display = 'none';

            if (window.formatSkinTitles) {
                window.formatSkinTitles();
            }

            filterButton.addEventListener('click', function() {
                const isHidden = filterPanel.style.display === 'none' || !filterPanel.style.display;
                filterPanel.style.display = isHidden ? 'block' : 'none';
                filterButton.classList.toggle('panel-open', isHidden);
            });
            
            // Handle filters and search
            const searchBox = document.getElementById('search-box');
            const items = document.querySelectorAll('.skin-item');
            const showingCount = document.getElementById('showing-count');
            const checkboxes = document.querySelectorAll('.filter-checkbox');
            
            // Add clickable selection functionality to items
            items.forEach(item => {
                item.addEventListener('click', function(event) {
                    if (event.target.closest('.inspect-btn') || event.target.closest('.trade-protected-badge')) {
                        return;
                    }

                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Toggle selected class for visual feedback
                    this.classList.toggle('selected');
                });
            });
            
            function applyFilters() {
                const searchTerm = searchBox.value.toLowerCase();
                const activeFilters = {
                    tradable: getActiveValues('tradable'),
                    weapon: getActiveValues('weapon_type'),  // Fixed: was 'weapon'
                    type: getActiveValues('item_type')       // Fixed: was 'type'
                };
                
                let visibleCount = 0;
                
                // Apply filters to each item
                items.forEach(item => {
                    const tradable = item.dataset.tradable;
                    const weapon = item.dataset.weapon;
                    const type = item.dataset.type;
                    const itemText = item.textContent.toLowerCase();
                    
                    const matchesTradable = activeFilters.tradable.length === 0 || activeFilters.tradable.includes(tradable);
                    const matchesWeapon = activeFilters.weapon.length === 0 || activeFilters.weapon.includes(weapon);
                    const matchesType = activeFilters.type.length === 0 || activeFilters.type.includes(type);
                    const matchesSearch = searchTerm === '' || itemText.includes(searchTerm);
                    
                    const isVisible = matchesTradable && matchesWeapon && matchesType && matchesSearch;
                    item.style.display = isVisible ? 'flex' : 'none';
                    
                    if (isVisible) {
                        visibleCount++;
                    }
                });
                
                // Update count
                showingCount.textContent = visibleCount;
            }
            
            // Helper to get active values for a filter category
            function getActiveValues(filterType) {
                const values = [];
                document.querySelectorAll(`.filter-checkbox[data-type="${filterType}"]:checked`).forEach(cb => {
                    values.push(cb.value);
                });
                return values;
            }
            
            // Apply filters when inputs change
            searchBox.addEventListener('input', applyFilters);
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
            
            // Initialize filters on page load
            applyFilters();

            if (window.InventoryUI) {
                window.InventoryUI.bindSkinActions(document.getElementById('inventory'));
            }
        });
    </script>
    {% endif %}
{% endblock %}
