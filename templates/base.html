{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Grejty CS2 Shop{% endblock %}</title>
    <meta name="title" lang="en" content="Grejty CS2 Shop">
    <meta name="title" lang="sk" content="Grejty CS2 Shop">
    <meta name="description" lang="en" content="Grejty CS2 Shop ‚Äì buying &amp; selling CS2 skins since 2016 with 20,000+ trades and 2,500+ reviews.">
    <meta name="description" lang="sk" content="Grejty CS2 Shop ‚Äì n√°kup a predaj CS2 skinov od roku 2016, viac ako 20 000 obchodov a 2 500 recenzi√≠.">
    <meta name="keywords" lang="en" content="Grejty CS2 Shop, buy CS2 skins, sell CS2 skins, CS2 trading, trusted CS2 seller">
    <meta name="keywords" lang="sk" content="Grejty CS2 Shop, k√∫pa CS2 skinov, predaj CS2 skinov, CS2 obchodovanie, overen√Ω CS2 predajca">
    <link rel="icon" type="image/png" href="{% static 'images/Avatar-Transparent.png' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    {% block styles %}{% endblock %}
</head>
<body{% if request.resolver_match and request.resolver_match.url_name == 'landing' %} class="landing-page"{% endif %}>
    {% if request.resolver_match and request.resolver_match.url_name == 'landing' %}
        <div class="landing-nav-spacer"></div>
    {% else %}
        <div class="top-nav">
            <div class="site-branding">
                <a href="{% url 'inventory:landing' %}">
                    <img src="{% static 'images/Avatar-Transparent.png' %}" alt="Grejty - CS2 SHOP" class="site-logo">
                    <span class="site-title">Grejty - CS2 Shop</span>
                </a>
            </div>
            <nav class="site-primary-nav" aria-label="Primary navigation">
                <ul class="site-primary-nav__list">
                    <li><a href="/about" class="site-primary-nav__link">About</a></li>
                    <li><a href="/reviews" class="site-primary-nav__link">Reviews</a></li>
                    <li><a href="/faq" class="site-primary-nav__link">FAQ</a></li>
                    <li><a href="/contact" class="site-primary-nav__link">Contact</a></li>
                </ul>
            </nav>
            <div class="nav-controls">
                {% if request.user.is_authenticated and request.resolver_match and request.resolver_match.url_name == 'admin' %}
                    <a href="{% url 'inventory:index' %}" class="nav-link">Skins for Sale</a>
                    <form method="post" action="{% url 'logout' %}" class="nav-logout-form">
                        {% csrf_token %}
                        <button type="submit" class="nav-link nav-link-button">Log out</button>
                    </form>
                {% endif %}
                <div class="locale-switcher">
                    <button type="button"
                            class="locale-switcher__button"
                            id="locale-switcher-button"
                            aria-haspopup="dialog"
                            aria-expanded="false"
                            aria-controls="locale-switcher-panel">
                        <span class="locale-switcher__currency-symbol" data-slot="currency-symbol">‚Ç¨</span>
                        <span class="locale-switcher__currency-code" data-slot="currency-code">EUR</span>
                        <span class="locale-switcher__divider" aria-hidden="true">|</span>
                        <span class="locale-switcher__language-code" data-slot="language-code">EN</span>
                    </button>
                    <div class="locale-switcher__panel" id="locale-switcher-panel" role="dialog" aria-labelledby="locale-switcher-title" hidden tabindex="-1">
                        <form class="locale-switcher__form" novalidate>
                            <h3 class="locale-switcher__title" id="locale-switcher-title">Language &amp; Currency</h3>
                            <label class="locale-switcher__label" for="locale-language">Language</label>
                            <select class="locale-switcher__select" id="locale-language" name="display-language">
                                <option value="en" data-short="EN">English</option>
                                <option value="sk" data-short="SK">Slovak</option>
                                <option value="cs" data-short="CZ">Czech</option>
                            </select>
                            <label class="locale-switcher__label" for="locale-currency">Display Currency</label>
                            <select class="locale-switcher__select" id="locale-currency" name="display-currency">
                                <option value="EUR" data-symbol="‚Ç¨">‚Ç¨ EUR</option>
                                <option value="USD" data-symbol="$">$ USD</option>
                                <option value="CZK" data-symbol="Kƒç">Kƒç CZK</option>
                            </select>
                            <p class="locale-switcher__disclaimer">Display currency is for display only, transactions remain in EUR.</p>
                            <div class="locale-switcher__actions">
                                <button type="button" class="locale-switcher__confirm">Confirm</button>
                            </div>
                        </form>
                    </div>
                </div>
                <button type="button" class="nav-icon-btn" aria-label="View cart" title="View cart">
                    <span class="nav-icon-btn__icon" aria-hidden="true"></span>
                </button>
                <!-- Simplified theme toggle -->
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light mode">üåô</button>
            </div>
        </div>
    {% endif %}
    
    <main>
        <div class="page-header">
            <h2>{% block header %}CS2 Inventory{% endblock %}</h2>
        </div>
        
        {% block content %}{% endblock %}
    </main>

    <footer class="site-footer" role="contentinfo">
        <div class="footer-shell">
            <div class="footer-column footer-column--meta">
                <p>¬© {% now "Y" %} Grejty</p>
                <p>Not associated with Valve Corporation</p>
            </div>
            <div class="footer-column footer-column--social" aria-label="Social media">
                <a href="#" class="footer-social footer-social--facebook" data-label="Facebook">
                    <span class="sr-only">Facebook</span>
                </a>
                <a href="#" class="footer-social footer-social--steam" data-label="Steam">
                    <span class="sr-only">Steam</span>
                </a>
                <a href="#" class="footer-social footer-social--twitter" data-label="Twitter / X">
                    <span class="sr-only">Twitter / X</span>
                </a>
            </div>
        </div>
    </footer>

    <div id="modal-shell" class="modal-shell" hidden>
        <div class="modal-overlay" data-modal-close="true"></div>
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <button type="button" class="modal-close" data-modal-close="true" aria-label="Close dialog"></button>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title"></h3>
                </div>
                <div class="modal-body" id="modal-body"></div>
                <div class="modal-footer" id="modal-footer"></div>
            </div>
        </div>
    </div>
    
    <script>
        const THEME_STORAGE_KEY = 'preferred-theme';
        const LOCALE_STORAGE_KEY = 'display-settings';
        const DEFAULT_LOCALE = {
            language: 'en',
            currency: 'EUR'
        };
        const LIGHT_THEME = 'light';
        const DARK_THEME = 'dark';

        document.addEventListener('DOMContentLoaded', () => {
            const root = document.documentElement;
            const toggle = document.getElementById('theme-toggle');

            const systemPreference = typeof window.matchMedia === 'function'
                ? window.matchMedia('(prefers-color-scheme: light)')
                : null;

            const getStoredTheme = () => {
                try {
                    return localStorage.getItem(THEME_STORAGE_KEY);
                } catch (error) {
                    return null;
                }
            };

            const storeTheme = (theme) => {
                try {
                    localStorage.setItem(THEME_STORAGE_KEY, theme);
                } catch (error) {
                    /* no-op if storage is unavailable */
                }
            };

            const updateThemeButton = (theme) => {
                if (!toggle) {
                    return;
                }

                if (theme === LIGHT_THEME) {
                    toggle.setAttribute('aria-label', 'Switch to dark mode');
                    toggle.textContent = '‚òÄÔ∏è';
                } else {
                    toggle.setAttribute('aria-label', 'Switch to light mode');
                    toggle.textContent = 'üåô';
                }
            };

            const applyTheme = (theme) => {
                const targetTheme = theme === LIGHT_THEME ? LIGHT_THEME : DARK_THEME;
                root.setAttribute('data-theme', targetTheme);
                updateThemeButton(targetTheme);
            };

            const savedTheme = getStoredTheme();
            if (savedTheme === LIGHT_THEME || savedTheme === DARK_THEME) {
                applyTheme(savedTheme);
            } else {
                const prefersLight = systemPreference ? systemPreference.matches : false;
                applyTheme(prefersLight ? LIGHT_THEME : DARK_THEME);
            }

            if (toggle) {
                toggle.addEventListener('click', () => {
                    const currentTheme = root.getAttribute('data-theme') === LIGHT_THEME ? LIGHT_THEME : DARK_THEME;
                    const nextTheme = currentTheme === DARK_THEME ? LIGHT_THEME : DARK_THEME;
                    applyTheme(nextTheme);
                    storeTheme(nextTheme);
                });
            }

            const handleSystemPreferenceChange = (event) => {
                const hasSavedPreference = getStoredTheme();
                if (hasSavedPreference !== LIGHT_THEME && hasSavedPreference !== DARK_THEME) {
                    applyTheme(event.matches ? LIGHT_THEME : DARK_THEME);
                }
            };

            if (systemPreference && typeof systemPreference.addEventListener === 'function') {
                systemPreference.addEventListener('change', handleSystemPreferenceChange);
            } else if (systemPreference && typeof systemPreference.addListener === 'function') {
                systemPreference.addListener(handleSystemPreferenceChange);
            }

            initLocaleSwitcher();

            function initLocaleSwitcher() {
                const switcher = document.getElementById('locale-switcher-button');
                const panel = document.getElementById('locale-switcher-panel');
                if (!switcher || !panel) {
                    return;
                }

                const form = panel.querySelector('.locale-switcher__form');
                const languageSelect = form?.querySelector('#locale-language');
                const currencySelect = form?.querySelector('#locale-currency');
                const confirmButton = form?.querySelector('.locale-switcher__confirm');
                const currencySymbolSlot = switcher.querySelector('[data-slot="currency-symbol"]');
                const currencyCodeSlot = switcher.querySelector('[data-slot="currency-code"]');
                const languageCodeSlot = switcher.querySelector('[data-slot="language-code"]');

                if (!form || !languageSelect || !currencySelect || !confirmButton || !currencySymbolSlot || !currencyCodeSlot || !languageCodeSlot) {
                    return;
                }

                let panelOpen = false;

                const getStoredLocale = () => {
                    try {
                        const stored = localStorage.getItem(LOCALE_STORAGE_KEY);
                        return stored ? JSON.parse(stored) : {};
                    } catch (error) {
                        return {};
                    }
                };

                const storeLocale = (settings) => {
                    try {
                        localStorage.setItem(LOCALE_STORAGE_KEY, JSON.stringify(settings));
                    } catch (error) {
                        /* storage unavailable, ignore */
                    }
                };

                const updateButtonLabel = () => {
                    const currencyOption = currencySelect.options[currencySelect.selectedIndex];
                    const languageOption = languageSelect.options[languageSelect.selectedIndex];
                    const currencySymbol = currencyOption?.dataset.symbol || currencyOption?.textContent?.trim().split(' ')[0] || '‚Ç¨';
                    const currencyCode = currencyOption?.value || 'EUR';
                    const languageShort = languageOption?.dataset.short || languageOption?.value?.slice(0, 2)?.toUpperCase() || 'EN';

                    currencySymbolSlot.textContent = currencySymbol;
                    currencyCodeSlot.textContent = currencyCode.toUpperCase();
                    languageCodeSlot.textContent = languageShort.toUpperCase();
                };

                const applyStoredLocale = () => {
                    const stored = getStoredLocale();

                    let languageValue = stored.language;
                    if (!languageValue || !languageSelect.querySelector(`option[value="${languageValue}"]`)) {
                        languageValue = DEFAULT_LOCALE.language;
                    }

                    let currencyValue = stored.currency;
                    if (!currencyValue || !currencySelect.querySelector(`option[value="${currencyValue}"]`)) {
                        currencyValue = DEFAULT_LOCALE.currency;
                    }

                    languageSelect.value = languageValue;
                    currencySelect.value = currencyValue;

                    updateButtonLabel();

                    if (stored.language !== languageValue || stored.currency !== currencyValue) {
                        storeLocale({
                            language: languageValue,
                            currency: currencyValue
                        });
                    }
                };

                const openPanel = () => {
                    if (panelOpen) {
                        return;
                    }

                    panel.hidden = false;
                    panelOpen = true;
                    switcher.setAttribute('aria-expanded', 'true');
                    (languageSelect || panel).focus();

                    document.addEventListener('mousedown', handleOutsideClick);
                    document.addEventListener('touchstart', handleOutsideClick);
                    document.addEventListener('keydown', handleKeydown);
                };

                const closePanel = () => {
                    if (!panelOpen) {
                        return;
                    }

                    panel.hidden = true;
                    panelOpen = false;
                    switcher.setAttribute('aria-expanded', 'false');

                    document.removeEventListener('mousedown', handleOutsideClick);
                    document.removeEventListener('touchstart', handleOutsideClick);
                    document.removeEventListener('keydown', handleKeydown);
                };

                const handleOutsideClick = (event) => {
                    if (!panel.contains(event.target) && !switcher.contains(event.target)) {
                        closePanel();
                    }
                };

                const handleKeydown = (event) => {
                    if (event.key === 'Escape') {
                        closePanel();
                        switcher.focus();
                    }
                };

                switcher.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (panelOpen) {
                        closePanel();
                    } else {
                        openPanel();
                    }
                });

                confirmButton.addEventListener('click', () => {
                    updateButtonLabel();
                    storeLocale({
                        language: languageSelect.value,
                        currency: currencySelect.value
                    });
                    closePanel();
                });

                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                });

                applyStoredLocale();
            }
        });

        function formatSkinTitles() {
            document.querySelectorAll('.skin-title').forEach(title => {
                if (title.dataset.formatted === 'true') {
                    return;
                }

                const segments = title.textContent.split('|').map(part => part.trim()).filter(Boolean);
                if (segments.length > 1) {
                    title.textContent = '';
                    segments.forEach((part, index) => {
                        const span = document.createElement('span');
                        span.textContent = part;
                        title.appendChild(span);
                        if (index < segments.length - 1) {
                            title.appendChild(document.createElement('br'));
                        }
                    });
                }

                title.dataset.formatted = 'true';
            });
        }

        window.formatSkinTitles = formatSkinTitles;

        document.addEventListener('DOMContentLoaded', formatSkinTitles);

        document.addEventListener('DOMContentLoaded', function() {
            const shell = document.getElementById('modal-shell');
            if (!shell) {
                return;
            }

            const overlay = shell.querySelector('.modal-overlay');
            const windowEl = shell.querySelector('.modal-window');
            const titleEl = shell.querySelector('#modal-title');
            const bodyEl = shell.querySelector('#modal-body');
            const footerEl = shell.querySelector('#modal-footer');

            function closeModal() {
                shell.setAttribute('hidden', '');
                shell.classList.remove('visible');
                bodyEl.innerHTML = '';
                footerEl.innerHTML = '';
                windowEl.removeAttribute('data-modal-type');
            }

            function buildActionButton(action) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `modal-btn ${action.variant ? `modal-btn-${action.variant}` : ''}`.trim();
                btn.textContent = action.label;
                btn.addEventListener('click', async () => {
                    if (typeof action.onClick === 'function') {
                        const result = await action.onClick();
                        if (result === false) {
                            return;
                        }
                    }
                    closeModal();
                });
                return btn;
            }

            function openModal({ title, body, actions = [], modalType = null }) {
                titleEl.textContent = title || '';
                bodyEl.innerHTML = '';
                footerEl.innerHTML = '';

                if (body instanceof Node) {
                    bodyEl.appendChild(body);
                } else if (typeof body === 'string') {
                    bodyEl.innerHTML = body;
                }

                const frag = document.createDocumentFragment();
                actions.forEach(action => {
                    frag.appendChild(buildActionButton(action));
                });
                footerEl.appendChild(frag);

                if (modalType) {
                    windowEl.setAttribute('data-modal-type', modalType);
                }

                shell.removeAttribute('hidden');
                requestAnimationFrame(() => {
                    shell.classList.add('visible');
                });
            }

            shell.addEventListener('click', event => {
                if (event.target.closest('[data-modal-close]')) {
                    closeModal();
                }
            });

            document.addEventListener('keyup', event => {
                if (event.key === 'Escape' && !shell.hasAttribute('hidden')) {
                    closeModal();
                }
            });

            window.AppModal = {
                open: openModal,
                close: closeModal
            };

            window.InventoryUI = {
                bindSkinActions(scope) {
                    const root = scope || document;
                    const modal = window.AppModal;
                    if (!modal) {
                        return;
                    }

                    const inspectButtons = root.querySelectorAll('.inspect-btn');
                    inspectButtons.forEach(btn => {
                        if (btn.dataset.bound === 'true') {
                            return;
                        }
                        btn.dataset.bound = 'true';
                        btn.addEventListener('click', event => {
                            event.preventDefault();
                            const link = btn.dataset.inspectLink;
                            if (!link) {
                                return;
                            }
                            window.location.href = link;
                        });
                    });
                }
            };
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
