{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CS2 Inventory Showroom{% endblock %}</title>
    <link rel="icon" type="image/png" href="{% static 'images/Avatar-Transparent.png' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    {% block styles %}{% endblock %}
</head>
<body>
    <div class="top-nav">
        <div class="site-branding">
            <a href="{% url 'inventory:index' %}">
                <img src="{% static 'images/Avatar-Transparent.png' %}" alt="Grejty - CS2 SHOP" class="site-logo">
                <span class="site-title">Grejty - CS2 Shop</span>
            </a>
        </div>
        <div class="nav-controls">
            {% if request.user.is_authenticated and request.resolver_match.url_name != 'index' %}
                <a href="{% url 'inventory:index' %}" class="nav-link">View Showroom</a>
                <form method="post" action="{% url 'logout' %}" class="nav-logout-form">
                    {% csrf_token %}
                    <button type="submit" class="nav-link nav-link-button">Log out</button>
                </form>
            {% endif %}
            <!-- Simplified theme toggle -->
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light mode">🌙</button>
        </div>
    </div>
    
    <main>
        <div class="page-header">
            <h2>{% block header %}CS2 Inventory{% endblock %}</h2>
        </div>
        
        {% block content %}{% endblock %}
    </main>

    <div id="modal-shell" class="modal-shell" hidden>
        <div class="modal-overlay" data-modal-close="true"></div>
        <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <button type="button" class="modal-close" data-modal-close="true" aria-label="Close dialog"></button>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title"></h3>
                </div>
                <div class="modal-body" id="modal-body"></div>
                <div class="modal-footer" id="modal-footer"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Simplified theme toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            
            // Check for saved theme preference or use default dark theme
            const currentTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            // Set the icon based on current theme
            themeToggle.textContent = currentTheme === 'light' ? '☀️' : '🌙';
            
            // Function to switch theme
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeToggle.textContent = newTheme === 'light' ? '☀️' : '🌙';
            });
        });
        
        function formatSkinTitles() {
            document.querySelectorAll('.skin-title').forEach(title => {
                if (title.dataset.formatted === 'true') {
                    return;
                }

                const segments = title.textContent.split('|').map(part => part.trim()).filter(Boolean);
                if (segments.length > 1) {
                    title.textContent = '';
                    segments.forEach((part, index) => {
                        const span = document.createElement('span');
                        span.textContent = part;
                        title.appendChild(span);
                        if (index < segments.length - 1) {
                            title.appendChild(document.createElement('br'));
                        }
                    });
                }

                title.dataset.formatted = 'true';
            });
        }

        window.formatSkinTitles = formatSkinTitles;

        document.addEventListener('DOMContentLoaded', formatSkinTitles);

        document.addEventListener('DOMContentLoaded', function() {
            const shell = document.getElementById('modal-shell');
            if (!shell) {
                return;
            }

            const overlay = shell.querySelector('.modal-overlay');
            const windowEl = shell.querySelector('.modal-window');
            const titleEl = shell.querySelector('#modal-title');
            const bodyEl = shell.querySelector('#modal-body');
            const footerEl = shell.querySelector('#modal-footer');

            function closeModal() {
                shell.setAttribute('hidden', '');
                shell.classList.remove('visible');
                bodyEl.innerHTML = '';
                footerEl.innerHTML = '';
                windowEl.removeAttribute('data-modal-type');
            }

            function buildActionButton(action) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `modal-btn ${action.variant ? `modal-btn-${action.variant}` : ''}`.trim();
                btn.textContent = action.label;
                btn.addEventListener('click', async () => {
                    if (typeof action.onClick === 'function') {
                        const result = await action.onClick();
                        if (result === false) {
                            return;
                        }
                    }
                    closeModal();
                });
                return btn;
            }

            function openModal({ title, body, actions = [], modalType = null }) {
                titleEl.textContent = title || '';
                bodyEl.innerHTML = '';
                footerEl.innerHTML = '';

                if (body instanceof Node) {
                    bodyEl.appendChild(body);
                } else if (typeof body === 'string') {
                    bodyEl.innerHTML = body;
                }

                const frag = document.createDocumentFragment();
                actions.forEach(action => {
                    frag.appendChild(buildActionButton(action));
                });
                footerEl.appendChild(frag);

                if (modalType) {
                    windowEl.setAttribute('data-modal-type', modalType);
                }

                shell.removeAttribute('hidden');
                requestAnimationFrame(() => {
                    shell.classList.add('visible');
                });
            }

            shell.addEventListener('click', event => {
                if (event.target.closest('[data-modal-close]')) {
                    closeModal();
                }
            });

            document.addEventListener('keyup', event => {
                if (event.key === 'Escape' && !shell.hasAttribute('hidden')) {
                    closeModal();
                }
            });

            window.AppModal = {
                open: openModal,
                close: closeModal
            };

            window.InventoryUI = {
                bindSkinActions(scope) {
                    const root = scope || document;
                    const modal = window.AppModal;
                    if (!modal) {
                        return;
                    }

                    const inspectButtons = root.querySelectorAll('.inspect-btn');
                    inspectButtons.forEach(btn => {
                        if (btn.dataset.bound === 'true') {
                            return;
                        }
                        btn.dataset.bound = 'true';
                        btn.addEventListener('click', event => {
                            event.preventDefault();
                            const link = btn.dataset.inspectLink;
                            if (!link) {
                                return;
                            }
                            window.location.href = link;
                        });
                    });
                }
            };
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
